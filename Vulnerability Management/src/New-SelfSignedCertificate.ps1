<#
.SYNOPSIS
    Creates a self-signed certificate for multi-tenant application authentication.

.DESCRIPTION
    This script generates a self-signed certificate with both public and private keys.
    The public key (.cer) can be used for application registration in Entra ID,
    while the private key (.pfx) can be imported into Azure Key Vault for secure storage.

.NOTES
    2025-12-28: Initial script created by Des Wass.

#>

# Variables
$org          = "Canary IT"
$app          = "CTS MS TVMS"
$certLabel    = "$org $app MultiTenant Auth"
$dnsName      = "canaryit-ms-core-auth"   # label only
$years        = 2

$outDir       = "$env:USERPROFILE\Downloads\cts-cert"
New-Item -ItemType Directory -Path $outDir -Force | Out-Null

$cerPath      = Join-Path $outDir "cts-ms-tvms.cer"
$pfxPath      = Join-Path $outDir "cts-ms-tvms.pfx"

# Create cert in CurrentUser\My
$cert = New-SelfSignedCertificate `
  -Subject "CN=$certLabel" `
  -DnsName $dnsName `
  -CertStoreLocation "Cert:\CurrentUser\My" `
  -KeyAlgorithm RSA `
  -KeyLength 2048 `
  -KeyExportPolicy Exportable `
  -KeySpec Signature `
  -HashAlgorithm SHA256 `
  -NotAfter (Get-Date).AddYears($years)

# Export public key (.cer) for Entra app registration
Export-Certificate -Cert $cert -FilePath $cerPath | Out-Null

# Export private key (.pfx) for Key Vault import
$pfxPassword = Read-Host -AsSecureString "Enter a password to protect the PFX"
Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $pfxPassword | Out-Null

# Output thumbprint for reference
$cert.Thumbprint

# End.